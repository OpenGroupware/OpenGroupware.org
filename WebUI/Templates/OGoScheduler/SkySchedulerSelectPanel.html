<style>
.apt-type-dropdown {
  display: inline-block;
  position: relative;
  vertical-align: middle;
}
button.dropdown {
  background: #fff;
  border: 1px solid #767676;
  border-radius: 2px;
  padding: 0 4px;
  font-size: 13px;
  cursor: pointer;
}
.apt-type-dropdown-menu {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background: #f6f6f6;
  border: 1px solid #b0b0b0;
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 100;
  min-width: 120px;
  max-height: 300px;
  overflow-y: auto;
  padding: 4px 0;
  font-size: 13px;
}
.apt-type-dropdown-menu label {
  display: block;
  padding: 2px 8px;
  white-space: nowrap;
  cursor: pointer;
}
.apt-type-dropdown-menu label:hover {
  background: #0069d9;
  color: #fff;
}
.apt-type-buttons {
  border-top: 1px solid #ccc;
  padding: 4px 8px;
  margin-top: 4px;
  text-align: right;
}
.apt-type-buttons button {
  margin-left: 4px;
  padding: 2px 8px;
  font-size: 12px;
  cursor: pointer;
}
</style>
<script>
var originalAptTypeState = [];

function toggleAptTypeDropdown(btn) {
  var menu = btn.nextElementSibling;
  var isOpen = menu.style.display === 'block';

  // Close any open dropdowns first (submit if was open)
  document.querySelectorAll('.apt-type-dropdown-menu').forEach(function(m) {
    if (m.style.display === 'block' && m !== menu) {
      document.windowform.submit();
      return;
    }
    m.style.display = 'none';
  });

  if (!isOpen) {
    // Save original state before opening
    originalAptTypeState = [];
    menu.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
      originalAptTypeState.push(cb.checked);
    });
    menu.style.display = 'block';
  }
  else {
    // Clicking button while open = submit
    document.windowform.submit();
  }
}

function onAptTypeChanged(checkbox, isAllTypes) {
  var menu = checkbox.closest('.apt-type-dropdown-menu');
  var checkboxes = menu.querySelectorAll('input[type="checkbox"]');

  if (isAllTypes) {
    // "alle Typen" toggled - sync all others to same state
    var newState = checkbox.checked;
    checkboxes.forEach(function(cb) {
      if (cb !== checkbox) cb.checked = newState;
    });
  }
  // Don't submit - wait for OK/Cancel/outside click
}

function submitAptTypes() {
  document.windowform.submit();
}

function cancelAptTypes(btn) {
  var menu = btn.closest('.apt-type-dropdown-menu');
  var checkboxes = menu.querySelectorAll('input[type="checkbox"]');
  // Restore original state
  checkboxes.forEach(function(cb, i) {
    cb.checked = originalAptTypeState[i];
  });
  menu.style.display = 'none';
}

// Close dropdown when clicking outside - submit on close
document.addEventListener('click', function(e) {
  if (!e.target.closest('.apt-type-dropdown')) {
    var openMenu =
      document.querySelector('.apt-type-dropdown-menu[style*="block"]');
    if (openMenu) {
      document.windowform.submit();
    }
  }
});
</script>
<#Form>
  <table border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr bgcolor="#E0E0E0">
      <td align="left" valign="middle" width="99%"
        ><#ExtendedCondElse><#CompanyFilterPopUp/></#ExtendedCondElse
        ><#ExtendedCond><#BigSearchField/></#ExtendedCond
        ><#TimeZonePopUp/><#IsWeekModeCond><#WeekPopUp/></#IsWeekModeCond
        ><#IsMonthModeCond><#MonthPopUp/></#IsMonthModeCond
        ><#ShowAptTypesCond
          ><div class="apt-type-dropdown"
            ><button type="button" class="dropdown"
                     onclick="toggleAptTypeDropdown(this)"
              ><#AptTypeDropdownLabel/> &#9662;</button
            ><div class="apt-type-dropdown-menu"
              ><#AptTypesRepetition
                ><label
                  ><#AptTypeCheckbox/> <#AptTypeLabel/></label
                ></#AptTypesRepetition
              ><div class="apt-type-buttons"
                ><button type="button" onclick="submitAptTypes()">OK</button
                ><button type="button"
                         onclick="cancelAptTypes(this)">Cancel</button
              ></div
            ></div
          ></div
          ></#ShowAptTypesCond
        ><#ExtendLink><#ExtendImg/></#ExtendLink
        ><#Submit/></td>
      
      <#IsDayModeCond>
        <td align="right" valign="middle"><#LastDay><#LastDayImg/></#LastDay></td>
        <td align="right" valign="middle"><nobr><#ThisDay /></nobr></td>
        <td align="right" valign="middle"><#NextDay><#NextDayImg/></#NextDay></td>
      </#IsDayModeCond>
      
      <#IsWeekModeCond>
        <td align="right" valign="middle"><#LastWeek><#LastWeekImg/></#LastWeek></td>
        <td align="right" valign="middle"><nobr><#ThisWeek /></nobr></td>
        <td align="right" valign="middle"><#NextWeek><#NextWeekImg/></#NextWeek></td>
      </#IsWeekModeCond>

      <#IsMonthModeCond>
        <td align="right" valign="middle"><#LastMonth><#LastMonthImg/></#LastMonth></td>
        <td align="right" valign="middle"><nobr><#ThisMonth /></nobr></td>
        <td align="right" valign="middle"><#NextMonth><#NextMonthImg/></#NextMonth></td>
      </#IsMonthModeCond>

      <#IsYearModeCond>
        <td align="right" valign="middle"><#LastYear><#LastYearImg/></#LastYear></td>
        <td align="right" valign="middle"><nobr><#ThisYear /></nobr></td>
        <td align="right" valign="middle"><#NextYear><#NextYearImg/></#NextYear></td>
      </#IsYearModeCond>
    </tr>
    
    <#ExtendedCond>
      <tr bgcolor="#e0e0e0"><td  align="left" valign="middle">
      <table cellspacing="0" cellpadding="1" border="0">
      <#HasAccountsCond>
        <tr bgcolor="#e0e0e0">
          <th align="left" valign="top" colspan="12">
            <#Font><#AccountsLabel/></#Font>
          </th>
        </tr>
        <#AccountsList/>
      </#HasAccountsCond>
      
      <#HasPersonsCond>
        <tr bgcolor="#e0e0e0">
          <th align="left" valign="top" colspan="12">
            <#Font><#PersonsLabel/></#Font>
          </th>
        </tr>
        <#PersonsList/>
      </#HasPersonsCond>
      
      <#HasTeamsCond>
        <tr bgcolor="#E0E0E0">
          <th align="left" valign="top" colspan="12">
            <#Font><#TeamsLabel/></#Font>
          </th>
        </tr>
        <#TeamsList/>
      </#HasTeamsCond>
      
      <#HasResourcesCond>
        <tr bgcolor="#E0E0E0">
          <th align="left" valign="top" colspan="12">
            <#Font><#ResourcesLabel/></#Font>
          </th>
        </tr>
        <#ResourcesList/>
      </#HasResourcesCond>
      </table></td>
      
      <td align="right" valign="top"> &nbsp;</td>
      <td align="right" valign="top"> &nbsp;</td>
      <td align="right" valign="top"> &nbsp;</td>      
    </tr>
    </#ExtendedCond>
  </table>
</#Form>
